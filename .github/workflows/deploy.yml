name: CI/CD for Microservices and Static Website (Blue-Green)

on:
  push:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      game: ${{ steps.filter.outputs.game }}
      analytics: ${{ steps.filter.outputs.analytics }}
      order: ${{ steps.filter.outputs.order }}
      static: ${{ steps.filter.outputs.static }}
    steps:
      - uses: actions/checkout@v3

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            game:
              - 'game-service/**'
            analytics:
              - 'analytics-service/**'
            order:
              - 'order-service/**'
            static:
              - 'templatemo_589_lugx_gaming/**'

  deploy-game:
    needs: detect-changes
    if: needs.detect-changes.outputs.game == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push game-service image
        run: |
          IMAGE_TAG=${{ github.sha }}
          cd game-service
          docker build --no-cache -t shalini1772/game-service:$IMAGE_TAG .
          docker push shalini1772/game-service:$IMAGE_TAG

      - name: Configure AWS CLI & kubeconfig
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set region "${{ secrets.AWS_REGION }}"
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Detect current live color
        id: color
        run: |
          if kubectl get svc game-service-green -n game &>/dev/null; then
            echo "color=blue" >> $GITHUB_OUTPUT
          else
            echo "color=green" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to inactive color
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          COLOR=${{ steps.color.outputs.color }}
          export KUBECONFIG=$PWD/kubeconfig
          envsubst < game-service/k8s/game-service-$COLOR.yaml | kubectl apply -n game -f -
          kubectl rollout status deployment/game-service-$COLOR -n game

      - name: Update Ingress to point to new color
        run: |
          COLOR=${{ steps.color.outputs.color }}
          export KUBECONFIG=$PWD/kubeconfig
          sed "s/game-service-.*/game-service-$COLOR/" game-service/k8s/game-ingress.yaml | kubectl apply -n game -f -

      - name: Delete old deployment (optional)
        run: |
          COLOR=${{ steps.color.outputs.color }}
          if [ "$COLOR" == "green" ]; then
            OLD_COLOR="blue"
          else
            OLD_COLOR="green"
          fi
          kubectl delete deployment game-service-$OLD_COLOR -n game || true
          kubectl delete svc game-service-$OLD_COLOR -n game || true

  deploy-analytics:
    needs: detect-changes
    if: needs.detect-changes.outputs.analytics == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push analytics-service image
        run: |
          IMAGE_TAG=${{ github.sha }}
          cd analytics-service
          docker build --no-cache -t shalini1772/analytics-service:$IMAGE_TAG .
          docker push shalini1772/analytics-service:$IMAGE_TAG

      - name: Configure AWS CLI & kubeconfig
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set region "${{ secrets.AWS_REGION }}"
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Deploy analytics-service to EKS
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl create namespace analytics --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete pods -l app=analytics-service -n analytics --ignore-not-found
          envsubst < analytics-service/k8s/analytics-service-deployment.yaml | kubectl apply -n analytics -f -
          kubectl apply -f analytics-service/k8s/analytics-ingress.yaml -n analytics
          kubectl rollout status deployment/analytics-service -n analytics

  deploy-order:
    needs: detect-changes
    if: needs.detect-changes.outputs.order == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push order-service image
        run: |
          IMAGE_TAG=${{ github.sha }}
          cd order-service
          docker build --no-cache -t shalini1772/order-service:$IMAGE_TAG .
          docker push shalini1772/order-service:$IMAGE_TAG

      - name: Configure AWS CLI & kubeconfig
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set region "${{ secrets.AWS_REGION }}"
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Deploy order-service to EKS
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl create namespace order --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete pods -l app=order-service -n order --ignore-not-found
          envsubst < order-service/k8s/order-service-deployment.yaml | kubectl apply -n order -f -
          kubectl apply -f order-service/k8s/mysql-deployment.yaml -n order
          kubectl apply -f order-service/k8s/order-ingress.yaml -n order
          kubectl rollout status deployment/order-service -n order

  deploy-static-site:
    needs: detect-changes
    if: needs.detect-changes.outputs.static == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push static site image
        run: |
          IMAGE_TAG=${{ github.sha }}
          cd templatemo_589_lugx_gaming
          docker build --no-cache -t shalini1772/static-site:$IMAGE_TAG .
          docker push shalini1772/static-site:$IMAGE_TAG

      - name: Configure AWS CLI & kubeconfig
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set region "${{ secrets.AWS_REGION }}"
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Deploy static site to EKS
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl create namespace static --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete pods -l app=static-site -n static --ignore-not-found
          envsubst < templatemo_589_lugx_gaming/k8s/static-site-deployment.yaml | kubectl apply -n static -f -
          kubectl apply -f templatemo_589_lugx_gaming/k8s/static-ingress.yaml -n static
          kubectl rollout status deployment/static-site -n static
